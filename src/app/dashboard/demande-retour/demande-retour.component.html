<ngx-spinner bdColor = "rgba(0, 0, 0, 0.8)" size = "large" color = "#fff" type = "line-scale-pulse-out" [fullScreen] = "true"><p style="color: white" > Chargement... </p></ngx-spinner>

<div nz-row>
    <div nz-col nzSpan="12" style="text-align: left">
        <h2>Vous êtes en train de faire une demande :
            <span nz-typography nzType="danger">Retour</span>
        </h2>
    </div>
</div>


<h2>Filtre de recherche</h2>

<div nz-row>

    <div nz-col nzSpan="12" style="padding-right: 1.5em">
        <nz-form-item>
            <nz-form-label [nzSpan]="24">Personne concernée</nz-form-label>
            <nz-select [(ngModel)]="currentPersonneSelected" (ngModelChange)="personneSelectChange($event)" nzShowSearch nzAllowClear nzPlaceHolder="Selectionner une personne" >
                <nz-option *ngFor="let pers of personneList" [nzLabel]=" pers.serviceB? pers.nom + ' ' + pers.prenom + ' --- '+pers.serviceB?.libelle :  pers.nom + ' ' + pers.prenom " [nzValue]="pers"></nz-option>
            </nz-select>
        </nz-form-item>
    </div>

    <div nz-col nzSpan="12" style="padding-right: 1.5em">
        <nz-form-item>
            <nz-form-label [nzSpan]="24">Equipement</nz-form-label>
            <nz-select [(ngModel)]="currentEquipementSelected" (ngModelChange)="equipementSelectChange($event)" nzShowSearch nzAllowClear nzPlaceHolder="Selectionner l'équipement">
                <nz-option *ngFor="let equipement of gammeList" [nzLabel]=" equipement.libelle" [nzValue]="equipement"></nz-option>
            </nz-select>
        </nz-form-item>
    </div>

    <div nz-col nzSpan="12" style="padding-right: 1.5em">
        <nz-form-item>
            <nz-form-label [nzSpan]="24">Modele</nz-form-label>
            <nz-select [(ngModel)]="currentModelSelected" (ngModelChange)="modelSelectChange($event)"  nzShowSearch nzAllowClear nzPlaceHolder="Selectionner le model">
                <nz-option *ngFor="let model of modeleList" [nzLabel]=" model.libelle" [nzValue]="model"></nz-option>
            </nz-select>
        </nz-form-item>
    </div>

    <div nz-col nzSpan="12" style="padding-right: 1.5em">
        <nz-form-item>
            <nz-form-label [nzSpan]="24">Marque</nz-form-label>
            <nz-select [(ngModel)]="currentMarqueSelected" (ngModelChange)="marqueSelectChange($event)" nzShowSearch nzAllowClear nzPlaceHolder="Selectionner une marque">
                <nz-option *ngFor="let marque of marqueList" [nzLabel]="marque.libelle" [nzValue]="marque"></nz-option>
            </nz-select>
        </nz-form-item>
    </div>

</div>

<div nz-row>

    <nz-table #sortTable [nzData]="listOfDisplayData" nzTableLayout="fixed" [nzPageSize]="5" style="margin-top: 1.5em">
        <thead>
        <tr>
            <th nzCustomFilter *ngFor="let column of listOfColumn" [nzSortFn]="column.sortFn">
                {{ column.title }}

                <nz-filter-trigger *ngIf="column.title == 'Numero Série'" [(nzVisible)]="visibleNumero" [nzActive]="searchValueNumero.length > 0" [nzDropdownMenu]="menuNumero">
                    <i nz-icon nzType="search"></i>
                </nz-filter-trigger>

                <nz-filter-trigger *ngIf="column.title == 'Equipement'"  [(nzVisible)]="visibleEquipement" [nzActive]="searchValueEquipement.length > 0" [nzDropdownMenu]="menuEquipement">
                    <i nz-icon nzType="search"></i>
                </nz-filter-trigger>

                <nz-filter-trigger *ngIf="column.title == 'Marque'" [(nzVisible)]="visibleMarque" [nzActive]="searchValueMarque.length > 0" [nzDropdownMenu]="menuMarque">
                    <i nz-icon nzType="search"></i>
                </nz-filter-trigger>

                <nz-filter-trigger *ngIf="column.title == 'Modele'" [(nzVisible)]="visibleModele" [nzActive]="searchValueModele.length > 0" [nzDropdownMenu]="menuModele">
                    <i nz-icon nzType="search"></i>
                </nz-filter-trigger>

                <nz-filter-trigger *ngIf="column.title == 'Personne concernée'" [(nzVisible)]="visibleDemandeur" [nzActive]="searchValueDemandeur.length > 0" [nzDropdownMenu]="menuDemandeur">
                    <i nz-icon nzType="search"></i>
                </nz-filter-trigger>

            </th>
            <th> Détails</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let data of sortTable.data">

            <td>{{ data.produit.numSerie }}</td>
            <td>{{ data.gamme?.libelle }}</td>
            <td>{{ data.marque?.libelle }}</td>
            <td>{{ data.modele?.libelle }}</td>
            <td>{{ data.personne?.nom + ' ' + data.personne?.prenom   + ' -- ' + data.personne?.serviceB.libelle}}</td>

            <td>
                <button (click)="showModalForSubmission(data)" nz-button  nzType="success">
                    {{tokenService.isGestionnaire() ? 'Valider' : 'Soumettre'}}
                </button>
                &nbsp;
                <!--button (click)="openDrawer(data)" nz-button nzShape="circle" nzType="primary">
                    <i nz-icon nzTheme="outline" nzType="bars"></i>
                </button-->
            </td>
        </tr>
        </tbody>
    </nz-table>

    <nz-dropdown-menu #menuNumero="nzDropdownMenu">
        <div class="ant-table-filter-dropdown">
            <div class="search-box">
                <input type="text" nz-input placeholder="Rechercher equipement" [(ngModel)]="searchValueNumero" />
                <button nz-button nzSize="small" nzType="primary" (click)="searchNumero()" class="search-button">
                    Chercher
                </button>
                <button nz-button nzSize="small" (click)="resetNumero()"> Annuler </button>
            </div>
        </div>
    </nz-dropdown-menu>

    <nz-dropdown-menu #menuEquipement="nzDropdownMenu">
        <div class="ant-table-filter-dropdown">
            <div class="search-box">
                <input type="text" nz-input placeholder="Rechercher equipement" [(ngModel)]="searchValueEquipement" />
                <button nz-button nzSize="small" nzType="primary" (click)="searchEquipement()" class="search-button">
                    Chercher
                </button>
                <button nz-button nzSize="small" (click)="resetEquipement()"> Annuler </button>
            </div>
        </div>
    </nz-dropdown-menu>

    <nz-dropdown-menu #menuMarque="nzDropdownMenu">
        <div class="ant-table-filter-dropdown">
            <div class="search-box">
                <input type="text" nz-input placeholder="Rechercher equipement" [(ngModel)]="searchValueMarque" />
                <button nz-button nzSize="small" nzType="primary" (click)="searchMarque()" class="search-button">
                    Chercher
                </button>
                <button nz-button nzSize="small" (click)="resetMarque()"> Annuler </button>
            </div>
        </div>
    </nz-dropdown-menu>

    <nz-dropdown-menu #menuModele="nzDropdownMenu">
        <div class="ant-table-filter-dropdown">
            <div class="search-box">
                <input type="text" nz-input placeholder="Rechercher equipement" [(ngModel)]="searchValueModele" />
                <button nz-button nzSize="small" nzType="primary" (click)="searchModele()" class="search-button">
                    Chercher
                </button>
                <button nz-button nzSize="small" (click)="resetModele()"> Annuler </button>
            </div>
        </div>
    </nz-dropdown-menu>

    <nz-dropdown-menu #menuDemandeur="nzDropdownMenu">
        <div class="ant-table-filter-dropdown">
            <div class="search-box">
                <input type="text" nz-input placeholder="Rechercher equipement" [(ngModel)]="searchValueDemandeur" />
                <button nz-button nzSize="small" nzType="primary" (click)="searchDemandeur()" class="search-button">
                    Chercher
                </button>
                <button nz-button nzSize="small" (click)="resetDemandeur()"> Annuler </button>
            </div>
        </div>
    </nz-dropdown-menu>


</div>

<nz-drawer [nzVisible]="visibleDrawer" [nzWidth]="640" [nzClosable]="false" (nzOnClose)="closeDrawer()">
    <ng-container *nzDrawerContent>
        <h2 class="title" style=" margin-bottom: 24px;"> DÉTAILS COMPLÉMENTAIRE </h2>

        Lorem ipsum dolor sit amet, consectetur adipisicing elit. Accusamus aliquid asperiores aspernatur consequatur debitis dolore dolores illum, iusto labore neque nobis quibusdam quo repudiandae sapiente similique ullam velit veniam voluptatem.

    </ng-container>
</nz-drawer>


<nz-modal
  [(nzVisible)]="canShowModal"
  nzCentered
  nzTitle="DETAILS"
>
  <ng-container *nzModalContent >

    <div nz-row>

      <div nz-col nzSpan="24">

        Lorem ipsum dolor sit amet, consectetur adipisicing elit. Amet architecto beatae blanditiis, consequuntur cum cumque deserunt distinctio doloremque dolorum eos error eveniet excepturi ipsam molestiae nemo pariatur quaerat quisquam voluptates.

      </div>

    </div>
  </ng-container>
</nz-modal>


<!-- modal from submission -->
<nz-modal
        [(nzVisible)]="canShowModalForSubmission"
        nzTitle="Veuillez sélectionner le nouvel état du produit"
        (nzOnCancel)="handleCancel()"
        (nzOnOk)="handleOk()"
        [nzOkLoading]="isOkLoading"
>
    <div *nzModalContent>
     <div nz-row>
         <div nz-col nzSpan="24" style="padding-right: 1.5em">
             <nz-form-item>
                 <nz-form-label>Nouvel état du produit {{[null, undefined].includes(demandeProduitSelected) ? '-' : demandeProduitSelected.produit.numSerie}} </nz-form-label>
                 <nz-select [(ngModel)]="nouvelEtatProduit" (ngModelChange)="nouvelEtatProduitEnumChange($event)" nzShowSearch nzAllowClear nzPlaceHolder="Selectionner un état" >
                     <nz-option [nzLabel]="'Hors service'" [nzValue]="'HS'"></nz-option>
                     <nz-option [nzLabel]="'En état'" [nzValue]="'ETAT'"></nz-option>
                 </nz-select>
             </nz-form-item>
         </div>
     </div>
    </div>
    <div *nzModalFooter>
        <button nz-button nzType="danger" (click)="handleCancel()">Annuler</button>
        <button nz-button nzType="primary" [disabled]="[null, undefined].includes(nouvelEtatProduit)" (click)="handleOk()" [nzLoading]="isOkLoading">Valider</button>
    </div>
</nz-modal>
